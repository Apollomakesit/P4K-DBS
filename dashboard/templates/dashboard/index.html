{% extends "dashboard/base.html" %}

{% block title %}Dashboard - Pro4Kings{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Dashboard</h1>
            <p class="text-gray-400 mt-1">Real-time Pro4Kings server monitoring</p>
        </div>
        <div class="mt-4 md:mt-0 flex items-center space-x-2 text-sm text-gray-400">
            <i class="fas fa-clock"></i>
            <span id="last-update">Last updated: just now</span>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <!-- Total Players -->
        <div class="stat-card bg-p4k-card border border-p4k-border rounded-xl p-5 card-glow">
            <div class="flex items-center justify-between">
                <div class="w-12 h-12 bg-p4k-accent/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-users text-p4k-accent text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-gray-400 text-sm">Total Players</p>
                <p class="text-2xl font-bold text-white" id="stat-players">{{ "{:,}".format(total_players) }}</p>
            </div>
        </div>
        
        <!-- Online Now -->
        <div class="stat-card bg-p4k-card border border-p4k-border rounded-xl p-5 card-glow">
            <div class="flex items-center justify-between">
                <div class="w-12 h-12 bg-p4k-green/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-circle pulse-online text-p4k-green text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-gray-400 text-sm">Online Now</p>
                <p class="text-2xl font-bold text-p4k-green" id="stat-online">{{ "{:,}".format(online_count) }}</p>
            </div>
        </div>
        
        <!-- Total Actions -->
        <div class="stat-card bg-p4k-card border border-p4k-border rounded-xl p-5 card-glow">
            <div class="flex items-center justify-between">
                <div class="w-12 h-12 bg-p4k-purple/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-bolt text-p4k-purple text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-gray-400 text-sm">Total Actions</p>
                <p class="text-2xl font-bold text-white" id="stat-actions">{{ "{:,}".format(total_actions) }}</p>
            </div>
        </div>
        
        <!-- Actions 24h -->
        <div class="stat-card bg-p4k-card border border-p4k-border rounded-xl p-5 card-glow">
            <div class="flex items-center justify-between">
                <div class="w-12 h-12 bg-p4k-orange/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-p4k-orange text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-gray-400 text-sm">Actions (24h)</p>
                <p class="text-2xl font-bold text-white" id="stat-actions-24h">{{ "{:,}".format(actions_24h) }}</p>
            </div>
        </div>
        
        <!-- Logins Today -->
        <div class="stat-card bg-p4k-card border border-p4k-border rounded-xl p-5 card-glow">
            <div class="flex items-center justify-between">
                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-sign-in-alt text-blue-500 text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-gray-400 text-sm">Logins Today</p>
                <p class="text-2xl font-bold text-white">{{ "{:,}".format(logins_today) }}</p>
            </div>
        </div>
        
        <!-- Active Bans -->
        <div class="stat-card bg-p4k-card border border-p4k-border rounded-xl p-5 card-glow">
            <div class="flex items-center justify-between">
                <div class="w-12 h-12 bg-p4k-red/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-ban text-p4k-red text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-gray-400 text-sm">Active Bans</p>
                <p class="text-2xl font-bold text-p4k-red">{{ "{:,}".format(active_bans) }}</p>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Recent Actions -->
        <div class="lg:col-span-2 bg-p4k-card border border-p4k-border rounded-xl overflow-hidden">
            <div class="px-6 py-4 border-b border-p4k-border flex items-center justify-between">
                <h2 class="text-lg font-semibold text-white">
                    <i class="fas fa-list mr-2 text-p4k-accent"></i>Recent Actions
                </h2>
                <a href="/actions" class="text-sm text-p4k-accent hover:text-blue-400 transition-colors">
                    View all <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div class="divide-y divide-p4k-border max-h-96 overflow-y-auto scrollbar-thin">
                {% for action in recent_actions %}
                <div class="px-6 py-3 hover:bg-p4k-border/30 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full 
                                    {% if action.action_type == 'item_given' %}bg-emerald-500/20 text-emerald-400
                                    {% elif action.action_type == 'item_received' %}bg-green-500/20 text-green-400
                                    {% elif action.action_type == 'money_transfer' %}bg-yellow-500/20 text-yellow-400
                                    {% elif action.action_type == 'money_deposit' %}bg-amber-500/20 text-amber-400
                                    {% elif action.action_type == 'money_withdraw' %}bg-orange-500/20 text-orange-400
                                    {% elif action.action_type == 'chest_deposit' %}bg-blue-500/20 text-blue-400
                                    {% elif action.action_type == 'chest_withdraw' %}bg-sky-500/20 text-sky-400
                                    {% elif action.action_type == 'warning_received' %}bg-orange-600/20 text-orange-500
                                    {% elif action.action_type == 'ban_received' %}bg-red-600/20 text-red-500
                                    {% elif action.action_type == 'admin_jail' %}bg-red-500/20 text-red-400
                                    {% elif action.action_type == 'admin_unjail' %}bg-lime-500/20 text-lime-400
                                    {% elif action.action_type == 'admin_unban' %}bg-green-600/20 text-green-500
                                    {% elif action.action_type == 'mute_received' %}bg-zinc-500/20 text-zinc-400
                                    {% elif action.action_type == 'trade' %}bg-purple-500/20 text-purple-400
                                    {% elif action.action_type == 'vehicle_contract' %}bg-cyan-500/20 text-cyan-400
                                    {% elif action.action_type == 'vehicle_bought' %}bg-teal-500/20 text-teal-400
                                    {% elif action.action_type == 'vehicle_sold' %}bg-indigo-500/20 text-indigo-400
                                    {% elif action.action_type == 'vehicle_scrapped' %}bg-rose-500/20 text-rose-400
                                    {% elif action.action_type == 'bank_heist_delivery' %}bg-fuchsia-500/20 text-fuchsia-400
                                    {% elif action.action_type == 'faction_kicked' %}bg-red-700/20 text-red-600
                                    {% elif action.action_type == 'kill_character' %}bg-red-900/20 text-red-700
                                    {% else %}bg-gray-500/20 text-gray-400{% endif %}">
                                    {% if action.action_type == 'item_given' %}<i class="fas fa-hand-holding mr-1"></i>
                                    {% elif action.action_type == 'item_received' %}<i class="fas fa-gift mr-1"></i>
                                    {% elif action.action_type == 'money_transfer' %}<i class="fas fa-money-bill-transfer mr-1"></i>
                                    {% elif action.action_type == 'money_deposit' %}<i class="fas fa-piggy-bank mr-1"></i>
                                    {% elif action.action_type == 'money_withdraw' %}<i class="fas fa-money-bill-wave mr-1"></i>
                                    {% elif action.action_type == 'chest_deposit' %}<i class="fas fa-box-archive mr-1"></i>
                                    {% elif action.action_type == 'chest_withdraw' %}<i class="fas fa-box-open mr-1"></i>
                                    {% elif action.action_type == 'warning_received' %}<i class="fas fa-triangle-exclamation mr-1"></i>
                                    {% elif action.action_type == 'ban_received' %}<i class="fas fa-gavel mr-1"></i>
                                    {% elif action.action_type == 'admin_jail' %}<i class="fas fa-lock mr-1"></i>
                                    {% elif action.action_type == 'admin_unjail' %}<i class="fas fa-lock-open mr-1"></i>
                                    {% elif action.action_type == 'admin_unban' %}<i class="fas fa-user-check mr-1"></i>
                                    {% elif action.action_type == 'mute_received' %}<i class="fas fa-volume-xmark mr-1"></i>
                                    {% elif action.action_type == 'trade' %}<i class="fas fa-handshake mr-1"></i>
                                    {% elif action.action_type == 'vehicle_contract' %}<i class="fas fa-file-signature mr-1"></i>
                                    {% elif action.action_type == 'vehicle_bought' %}<i class="fas fa-car mr-1"></i>
                                    {% elif action.action_type == 'vehicle_sold' %}<i class="fas fa-car-side mr-1"></i>
                                    {% elif action.action_type == 'vehicle_scrapped' %}<i class="fas fa-car-burst mr-1"></i>
                                    {% elif action.action_type == 'bank_heist_delivery' %}<i class="fas fa-sack-dollar mr-1"></i>
                                    {% elif action.action_type == 'faction_kicked' %}<i class="fas fa-user-slash mr-1"></i>
                                    {% elif action.action_type == 'kill_character' %}<i class="fas fa-skull mr-1"></i>
                                    {% else %}<i class="fas fa-circle-info mr-1"></i>{% endif %}
                                    {{ action.action_type | replace("_", " ") | title }}
                                </span>
                                {% if action.player_name %}
                                <a href="/player/{{ action.player_id }}" class="text-p4k-accent hover:underline text-sm">
                                    {{ action.player_name }}
                                </a>
                                {% endif %}
                            </div>
                            <p class="text-gray-400 text-sm mt-1 truncate">{{ action.action_detail or action.raw_text or 'No details' }}</p>
                        </div>
                        <span class="text-xs text-gray-500 ml-4 whitespace-nowrap">
                            {{ action.timestamp | time_ago }}
                        </span>
                    </div>
                </div>
                {% else %}
                <div class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p>No recent actions</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Online Players -->
        <div class="bg-p4k-card border border-p4k-border rounded-xl overflow-hidden">
            <div class="px-6 py-4 border-b border-p4k-border flex items-center justify-between">
                <h2 class="text-lg font-semibold text-white">
                    <i class="fas fa-circle pulse-online text-p4k-green mr-2"></i>Online Players
                </h2>
                <a href="/online" class="text-sm text-p4k-accent hover:text-blue-400 transition-colors">
                    View all <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div class="divide-y divide-p4k-border max-h-96 overflow-y-auto scrollbar-thin">
                {% for player in online_players %}
                <a href="/player/{{ player.player_id }}" class="block px-6 py-3 hover:bg-p4k-border/30 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white font-medium">{{ player.player_name }}</p>
                            <p class="text-gray-500 text-xs">{{ player.faction or 'No faction' }}</p>
                        </div>
                        <span class="text-xs text-gray-500">ID: {{ player.player_id }}</span>
                    </div>
                </a>
                {% else %}
                <div class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-user-slash text-3xl mb-2"></i>
                    <p>No players online</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Top Factions -->
    <div class="bg-p4k-card border border-p4k-border rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-p4k-border flex items-center justify-between">
            <h2 class="text-lg font-semibold text-white">
                <i class="fas fa-shield-alt mr-2 text-p4k-purple"></i>Top Factions
            </h2>
            <a href="/factions" class="text-sm text-p4k-accent hover:text-blue-400 transition-colors">
                View all <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                {% for faction in top_factions %}
                <a href="/faction/{{ faction.faction }}" class="bg-p4k-border/30 rounded-lg p-4 hover:bg-p4k-border/50 transition-colors text-center">
                    <p class="text-white font-medium truncate">{{ faction.faction }}</p>
                    <p class="text-2xl font-bold text-p4k-accent mt-1">{{ faction.count }}</p>
                    <p class="text-gray-500 text-xs">members</p>
                </a>
                {% else %}
                <p class="text-gray-500 col-span-full text-center py-4">No factions found</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh stats every 30 seconds
setInterval(async function() {
    try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        document.getElementById('stat-players').textContent = data.total_players.toLocaleString();
        document.getElementById('stat-online').textContent = data.online_count.toLocaleString();
        document.getElementById('stat-actions').textContent = data.total_actions.toLocaleString();
        document.getElementById('stat-actions-24h').textContent = data.actions_24h.toLocaleString();
        
        document.getElementById('last-update').textContent = 'Last updated: just now';
    } catch (e) {
        console.error('Failed to refresh stats:', e);
    }
}, 30000);
</script>
{% endblock %}
