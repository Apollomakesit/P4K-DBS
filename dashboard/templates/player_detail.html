{% extends "base.html" %}

{% block title %}Player Details - P4K-DBS{% endblock %}
{% block page_title %}Player Details{% endblock %}

{% block content %}
<div x-data="playerDetailData('{{ player_id }}')" x-init="init()">
    <!-- Loading State -->
    <div x-show="loading" class="flex items-center justify-center py-20">
        <div class="flex items-center gap-3 text-gray-500">
            <svg class="animate-spin h-8 w-8" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg">Loading player data...</span>
        </div>
    </div>
    
    <!-- Player Not Found -->
    <div x-show="!loading && error" class="text-center py-20">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="text-xl font-medium text-gray-900 mb-2">Player Not Found</h3>
        <p class="text-gray-500 mb-4" x-text="error"></p>
        <a href="/players" class="btn btn-primary">Back to Players</a>
    </div>
    
    <!-- Player Profile -->
    <div x-show="!loading && player" x-cloak>
        <!-- Profile Header -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
            <div class="flex flex-col md:flex-row md:items-center gap-6">
                <!-- Avatar -->
                <div class="w-20 h-20 rounded-2xl flex items-center justify-center text-2xl font-bold"
                     :class="isOnline ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'">
                    <span x-text="player.username ? player.username[0].toUpperCase() : '?'"></span>
                </div>
                
                <!-- Info -->
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h1 class="text-2xl font-bold text-gray-900" x-text="player.username"></h1>
                        <span class="badge" :class="isOnline ? 'badge-green' : 'badge-gray'" x-text="isOnline ? 'üü¢ Online' : '‚ö´ Offline'"></span>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
                        <span>ID: <span class="font-medium text-gray-900" x-text="player.player_id"></span></span>
                        <span>‚Ä¢</span>
                        <span x-text="player.faction ? player.faction + (player.faction_rank ? ' - ' + player.faction_rank : '') : 'No faction'"></span>
                        <span>‚Ä¢</span>
                        <span x-text="player.job || 'Unemployed'"></span>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="flex gap-6">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-gray-900" x-text="player.played_hours ? player.played_hours.toFixed(1) : '0'"></p>
                        <p class="text-xs text-gray-500">Hours Played</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold" :class="player.warnings >= 3 ? 'text-red-600' : 'text-gray-900'" x-text="(player.warnings || 0) + '/3'"></p>
                        <p class="text-xs text-gray-500">Warnings</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-gray-900" x-text="player.age_ic || '?'"></p>
                        <p class="text-xs text-gray-500">Age IC</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex gap-4">
                    <button @click="activeTab = 'actions'" 
                            class="py-3 px-4 text-sm font-medium border-b-2 transition-colors"
                            :class="activeTab === 'actions' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                        Actions
                        <span class="ml-2 bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs" x-text="actions.length"></span>
                    </button>
                    <button @click="activeTab = 'sessions'" 
                            class="py-3 px-4 text-sm font-medium border-b-2 transition-colors"
                            :class="activeTab === 'sessions' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                        Sessions
                        <span class="ml-2 bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs" x-text="sessions.length"></span>
                    </button>
                </nav>
            </div>
        </div>
        
        <!-- Days Filter -->
        <div class="mb-4">
            <select x-model="days" @change="loadData()" class="input w-auto">
                <option value="7">Last 7 days</option>
                <option value="14">Last 14 days</option>
                <option value="30">Last 30 days</option>
            </select>
        </div>
        
        <!-- Actions Tab -->
        <div x-show="activeTab === 'actions'" class="table-container">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Type</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Details</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Target</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="action in actions" :key="action.id">
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-3 px-4">
                                    <span class="badge" :class="getActionBadgeClass(action.action_type)">
                                        <span x-text="getActionIcon(action.action_type) + ' ' + formatActionType(action.action_type)"></span>
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <p class="text-sm text-gray-900 max-w-md truncate" x-text="action.action_detail || '-'"></p>
                                </td>
                                <td class="py-3 px-4">
                                    <a x-show="action.target_player_id" 
                                       :href="'/player/' + action.target_player_id"
                                       class="text-sm text-indigo-600 hover:text-indigo-700"
                                       x-text="action.target_player_name || action.target_player_id"></a>
                                    <span x-show="!action.target_player_id" class="text-sm text-gray-400">-</span>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="text-sm text-gray-500" x-text="formatDateTime(action.timestamp)"></span>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="actions.length === 0">
                            <td colspan="4" class="py-12 text-center text-gray-500">No actions found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Sessions Tab -->
        <div x-show="activeTab === 'sessions'" class="table-container">
            <div class="p-4 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center gap-6 text-sm">
                    <span class="text-gray-500">First login: <span class="font-medium text-gray-900" x-text="sessionInfo.first_login ? formatDateTime(sessionInfo.first_login) : 'Never'"></span></span>
                    <span class="text-gray-500">Total sessions: <span class="font-medium text-gray-900" x-text="sessionInfo.total_sessions || 0"></span></span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Session</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Login Time</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Logout Time</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(session, index) in sessions" :key="index">
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-3 px-4">
                                    <span class="badge badge-blue" x-text="'#' + (sessions.length - index)"></span>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="text-sm text-gray-900" x-text="formatDateTime(session.login_time)"></span>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="text-sm text-gray-900" x-text="session.logout_time ? formatDateTime(session.logout_time) : 'Still online'"></span>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="text-sm text-gray-600" x-text="formatDuration(session.session_duration_seconds)"></span>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="sessions.length === 0">
                            <td colspan="4" class="py-12 text-center text-gray-500">No sessions found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function playerDetailData(playerId) {
    return {
        playerId: playerId,
        player: null,
        isOnline: false,
        actions: [],
        sessions: [],
        sessionInfo: {},
        loading: true,
        error: null,
        activeTab: 'actions',
        days: 7,
        
        async init() {
            await this.loadPlayer();
            await this.loadData();
        },
        
        async loadPlayer() {
            try {
                const response = await fetch(`/api/player/${this.playerId}`);
                if (!response.ok) {
                    this.error = 'Player not found';
                    this.loading = false;
                    return;
                }
                const data = await response.json();
                this.player = data.player;
                this.isOnline = data.is_online;
            } catch (error) {
                console.error('Error loading player:', error);
                this.error = 'Failed to load player data';
            } finally {
                this.loading = false;
            }
        },
        
        async loadData() {
            await Promise.all([
                this.loadActions(),
                this.loadSessions()
            ]);
        },
        
        async loadActions() {
            try {
                const response = await fetch(`/api/player/${this.playerId}/actions?days=${this.days}`);
                const data = await response.json();
                this.actions = data.actions || [];
            } catch (error) {
                console.error('Error loading actions:', error);
            }
        },
        
        async loadSessions() {
            try {
                const response = await fetch(`/api/player/${this.playerId}/sessions?days=${this.days}`);
                const data = await response.json();
                this.sessions = data.sessions || [];
                this.sessionInfo = {
                    first_login: data.first_login,
                    total_sessions: data.total_sessions
                };
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        },
        
        formatActionType(type) {
            if (!type) return 'Unknown';
            return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        },
        
        formatDateTime(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleString();
        },
        
        formatDuration(seconds) {
            if (!seconds) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        },
        
        getActionIcon(type) {
            const icons = {
                'item_given': 'üì§',
                'item_received': 'üì•',
                'money_transfer': 'üí∏',
                'money_deposit': 'üè¶',
                'money_withdraw': 'üèß',
                'chest_deposit': 'üì¶',
                'chest_withdraw': 'üìÇ',
                'warning_received': '‚ö†Ô∏è',
                'ban_received': 'üî®',
                'vehicle_contract': 'üìù',
                'trade': 'ü§ù'
            };
            return icons[type] || 'üìã';
        },
        
        getActionBadgeClass(type) {
            const classes = {
                'item_given': 'badge-blue',
                'item_received': 'badge-green',
                'money_transfer': 'badge-yellow',
                'warning_received': 'badge-red',
                'ban_received': 'badge-red',
                'vehicle_contract': 'badge-purple'
            };
            return classes[type] || 'badge-gray';
        }
    };
}
</script>
{% endblock %}
