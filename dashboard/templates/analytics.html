{% extends "base.html" %}

{% block title %}Analytics - P4K-DBS{% endblock %}

{% block content %}
<div x-data="analyticsPage()" x-init="init()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white flex items-center">
                <i class="fas fa-chart-line text-blue-500 mr-3"></i>
                Analytics Dashboard
            </h1>
            <p class="text-gray-400 mt-1">Activity trends, peak times, and insights</p>
        </div>
        <div class="flex items-center space-x-4">
            <select x-model="daysRange" @change="loadAllData()" 
                    class="bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500">
                <option value="7">Last 7 days</option>
                <option value="14">Last 14 days</option>
                <option value="30">Last 30 days</option>
            </select>
            <button @click="loadAllData()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                <i class="fas fa-sync-alt mr-2"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
        <p class="text-gray-400">Loading analytics data...</p>
    </div>

    <!-- Charts Grid -->
    <div x-show="!loading" class="space-y-8">
        
        <!-- Row 1: Login Activity + Actions Trend -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Login Activity Chart -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-sign-in-alt text-green-500 mr-2"></i>
                    Login/Logout Activity
                </h2>
                <div class="h-64">
                    <canvas id="loginActivityChart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-2xl font-bold text-green-500" x-text="totalLogins.toLocaleString()">0</div>
                        <div class="text-sm text-gray-400">Total Logins</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-2xl font-bold text-red-400" x-text="totalLogouts.toLocaleString()">0</div>
                        <div class="text-sm text-gray-400">Total Logouts</div>
                    </div>
                </div>
            </div>

            <!-- Actions Trend Chart -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-purple-500 mr-2"></i>
                    Actions Per Day
                </h2>
                <div class="h-64">
                    <canvas id="actionsTrendChart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-xl font-bold text-purple-500" x-text="totalActions.toLocaleString()">0</div>
                        <div class="text-sm text-gray-400">Total Actions</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-xl font-bold text-blue-500" x-text="avgActions.toLocaleString()">0</div>
                        <div class="text-sm text-gray-400">Daily Average</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-xl font-bold text-yellow-500" x-text="peakActions.toLocaleString()">0</div>
                        <div class="text-sm text-gray-400">Peak Day</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Peak Times Heatmap -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
            <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                <i class="fas fa-fire text-orange-500 mr-2"></i>
                Peak Online Times (Heatmap)
            </h2>
            <p class="text-gray-400 text-sm mb-4">Login activity by day of week and hour</p>
            
            <div class="overflow-x-auto">
                <div class="min-w-[900px]">
                    <!-- Hour labels -->
                    <div class="flex mb-2">
                        <div class="w-24"></div>
                        <template x-for="(hour, idx) in hoursLabels" :key="idx">
                            <div class="flex-1 text-center text-xs text-gray-500" x-text="hour.replace(':00', '')"></div>
                        </template>
                    </div>
                    
                    <!-- Heatmap rows -->
                    <template x-for="(day, dayIdx) in daysLabels" :key="dayIdx">
                        <div class="flex items-center mb-1">
                            <div class="w-24 text-sm text-gray-400 truncate" x-text="day.substr(0,3)"></div>
                            <template x-for="(hour, hourIdx) in 24" :key="hourIdx">
                                <div class="flex-1 h-8 mx-px rounded"
                                     :style="{ backgroundColor: getHeatmapColor(heatmapData[dayIdx]?.[hourIdx] || 0) }"
                                     :title="`${day} ${hourIdx}:00 - ${heatmapData[dayIdx]?.[hourIdx] || 0} logins`">
                                </div>
                            </template>
                        </div>
                    </template>
                    
                    <!-- Legend -->
                    <div class="flex items-center justify-center mt-4 space-x-4">
                        <span class="text-sm text-gray-400">Less</span>
                        <div class="flex space-x-1">
                            <div class="w-6 h-4 rounded" style="background-color: #1a1a2e"></div>
                            <div class="w-6 h-4 rounded" style="background-color: #3b3b5c"></div>
                            <div class="w-6 h-4 rounded" style="background-color: #5b5b8c"></div>
                            <div class="w-6 h-4 rounded" style="background-color: #7c7cbc"></div>
                            <div class="w-6 h-4 rounded" style="background-color: #9d9dec"></div>
                            <div class="w-6 h-4 rounded" style="background-color: #60a5fa"></div>
                        </div>
                        <span class="text-sm text-gray-400">More</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Faction Member Counts -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
            <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                <i class="fas fa-users text-cyan-500 mr-2"></i>
                Top Faction Member Counts
            </h2>
            <div class="h-80">
                <canvas id="factionChart"></canvas>
            </div>
        </div>

        <!-- Row 4: Action Type Breakdown -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Action Types Pie Chart -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-pink-500 mr-2"></i>
                    Action Type Distribution
                </h2>
                <div class="h-64">
                    <canvas id="actionTypesChart"></canvas>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-tachometer-alt text-yellow-500 mr-2"></i>
                    Quick Stats
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gradient-to-br from-blue-600/20 to-blue-800/20 rounded-lg p-4 border border-blue-500/30">
                        <i class="fas fa-user-friends text-blue-500 text-2xl mb-2"></i>
                        <div class="text-2xl font-bold text-white" x-text="stats.totalPlayers?.toLocaleString() || '...'">...</div>
                        <div class="text-sm text-gray-400">Total Players</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-600/20 to-green-800/20 rounded-lg p-4 border border-green-500/30">
                        <i class="fas fa-signal text-green-500 text-2xl mb-2"></i>
                        <div class="text-2xl font-bold text-white" x-text="stats.onlineNow?.toLocaleString() || '...'">...</div>
                        <div class="text-sm text-gray-400">Online Now</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600/20 to-purple-800/20 rounded-lg p-4 border border-purple-500/30">
                        <i class="fas fa-scroll text-purple-500 text-2xl mb-2"></i>
                        <div class="text-2xl font-bold text-white" x-text="stats.totalActions?.toLocaleString() || '...'">...</div>
                        <div class="text-sm text-gray-400">Total Actions</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-600/20 to-red-800/20 rounded-lg p-4 border border-red-500/30">
                        <i class="fas fa-ban text-red-500 text-2xl mb-2"></i>
                        <div class="text-2xl font-bold text-white" x-text="stats.activeBans?.toLocaleString() || '...'">...</div>
                        <div class="text-sm text-gray-400">Active Bans</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function analyticsPage() {
    return {
        loading: true,
        daysRange: 14,
        
        // Login activity
        totalLogins: 0,
        totalLogouts: 0,
        loginChart: null,
        
        // Actions trend
        totalActions: 0,
        avgActions: 0,
        peakActions: 0,
        actionsChart: null,
        
        // Heatmap
        daysLabels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
        hoursLabels: [],
        heatmapData: [],
        heatmapMax: 1,
        
        // Faction chart
        factionChart: null,
        
        // Action types
        actionTypesChart: null,
        
        // Stats
        stats: {},
        
        async init() {
            // Generate hours labels
            for (let i = 0; i < 24; i++) {
                this.hoursLabels.push(`${i.toString().padStart(2, '0')}:00`);
            }
            await this.loadAllData();
        },
        
        async loadAllData() {
            this.loading = true;
            
            try {
                await Promise.all([
                    this.loadLoginActivity(),
                    this.loadActionsTrend(),
                    this.loadPeakTimes(),
                    this.loadFactionData(),
                    this.loadActionTypes(),
                    this.loadStats()
                ]);
            } catch (e) {
                console.error('Error loading analytics:', e);
            }
            
            this.loading = false;
        },
        
        async loadLoginActivity() {
            const hours = this.daysRange * 24;
            const res = await fetch(`/api/login-activity?hours=${hours}`);
            const data = await res.json();
            
            this.totalLogins = data.data.reduce((sum, d) => sum + d.logins, 0);
            this.totalLogouts = data.data.reduce((sum, d) => sum + d.logouts, 0);
            
            // Aggregate by day for cleaner chart
            const byDay = {};
            data.data.forEach(d => {
                const day = d.hour.split(' ')[0];
                if (!byDay[day]) byDay[day] = { logins: 0, logouts: 0 };
                byDay[day].logins += d.logins;
                byDay[day].logouts += d.logouts;
            });
            
            const labels = Object.keys(byDay);
            const logins = Object.values(byDay).map(d => d.logins);
            const logouts = Object.values(byDay).map(d => d.logouts);
            
            this.renderLoginChart(labels, logins, logouts);
        },
        
        renderLoginChart(labels, logins, logouts) {
            const ctx = document.getElementById('loginActivityChart')?.getContext('2d');
            if (!ctx) return;
            
            if (this.loginChart) this.loginChart.destroy();
            
            this.loginChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => l.substr(5)),
                    datasets: [
                        {
                            label: 'Logins',
                            data: logins,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Logouts',
                            data: logouts,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    },
                    scales: {
                        x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                        y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                    }
                }
            });
        },
        
        async loadActionsTrend() {
            const res = await fetch(`/api/actions-trend?days=${this.daysRange}`);
            const data = await res.json();
            
            const counts = data.data.map(d => d.count);
            this.totalActions = counts.reduce((a, b) => a + b, 0);
            this.avgActions = Math.round(this.totalActions / counts.length);
            this.peakActions = Math.max(...counts);
            
            this.renderActionsChart(data.data);
        },
        
        renderActionsChart(data) {
            const ctx = document.getElementById('actionsTrendChart')?.getContext('2d');
            if (!ctx) return;
            
            if (this.actionsChart) this.actionsChart.destroy();
            
            this.actionsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.date.substr(5)),
                    datasets: [{
                        label: 'Actions',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                        y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                    }
                }
            });
        },
        
        async loadPeakTimes() {
            const res = await fetch(`/api/peak-times?days=${this.daysRange}`);
            const data = await res.json();
            
            this.heatmapData = data.heatmap || [];
            
            // Find max for color scaling
            this.heatmapMax = 1;
            data.heatmap.forEach(row => {
                row.forEach(val => {
                    if (val > this.heatmapMax) this.heatmapMax = val;
                });
            });
        },
        
        getHeatmapColor(value) {
            if (value === 0) return '#1f2937';
            
            const intensity = Math.min(value / this.heatmapMax, 1);
            
            if (intensity < 0.2) return '#1a1a2e';
            if (intensity < 0.4) return '#3b3b5c';
            if (intensity < 0.6) return '#5b5b8c';
            if (intensity < 0.8) return '#7c7cbc';
            if (intensity < 0.95) return '#9d9dec';
            return '#60a5fa';
        },
        
        async loadFactionData() {
            const res = await fetch('/api/faction-history');
            const data = await res.json();
            
            this.renderFactionChart(data.factions || []);
        },
        
        renderFactionChart(factions) {
            const ctx = document.getElementById('factionChart')?.getContext('2d');
            if (!ctx) return;
            
            if (this.factionChart) this.factionChart.destroy();
            
            const colors = [
                '#3b82f6', '#22c55e', '#ef4444', '#f59e0b', '#8b5cf6',
                '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
            ];
            
            this.factionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: factions.map(f => f.faction.length > 20 ? f.faction.substr(0, 20) + '...' : f.faction),
                    datasets: [{
                        label: 'Members',
                        data: factions.map(f => f.member_count),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                        y: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                    }
                }
            });
        },
        
        async loadActionTypes() {
            const res = await fetch('/api/action-stats');
            const data = await res.json();
            
            this.renderActionTypesChart(data.stats || []);
        },
        
        renderActionTypesChart(stats) {
            const ctx = document.getElementById('actionTypesChart')?.getContext('2d');
            if (!ctx) return;
            
            if (this.actionTypesChart) this.actionTypesChart.destroy();
            
            // Take top 8 action types
            const top = stats.slice(0, 8);
            
            const colors = [
                '#3b82f6', '#22c55e', '#ef4444', '#f59e0b', 
                '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
            ];
            
            this.actionTypesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: top.map(s => s.action_type.replace(/_/g, ' ')),
                    datasets: [{
                        data: top.map(s => s.count),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#9ca3af', boxWidth: 12 }
                        }
                    }
                }
            });
        },
        
        async loadStats() {
            const res = await fetch('/api/stats');
            this.stats = await res.json();
        }
    }
}
</script>
{% endblock %}
